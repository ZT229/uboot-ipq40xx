<!DOCTYPE html>
<html lang="zh">
<head>
	<meta charset="UTF-8">
	<title>å›ºä»¶å¤‡ä»½</title>
	<link rel="stylesheet" href="style.css">
</head>
<body>
	<div class="main-container">
		<nav class="side-nav">
			<a href="index.html" class="nav-item"><span>ğŸ“¦å›ºä»¶æ›´æ–°</span></a>
			<a href="uboot.html" class="nav-item"><span>ğŸš€UBOOTæ›´æ–°</span></a>
			<a href="art.html" class="nav-item"><span>ğŸ“¶ARTæ›´æ–°</span></a>
			<a href="mibib.html" class="nav-item"><span>ğŸ“ŠMIBIBæ›´æ–°</span></a>
			<a href="mac.html" class="nav-item"><span>ğŸ› ï¸MACç®¡ç†</span></a>
			<a href="env.html" class="nav-item"><span>âš™ï¸å˜é‡ç®¡ç†</span></a>
			<a href="backup.html" class="nav-item active"><span>ğŸ’¾å›ºä»¶å¤‡ä»½</span></a>
		</nav>
		<main class="content-area">
			<section class="content-page active" id="page-backup">
				<h1>ğŸ’¾å›ºä»¶å¤‡ä»½</h1>
				<div class="upload-card">
					<form id="backup-form" autocomplete="off">
						<div class="form-row">
							<div class="form-group">
								<label for="firmware-info">å›ºä»¶ä¿¡æ¯ï¼ˆSize@Addressï¼‰ï¼š</label>
								<input type="text" id="firmware-info" class="form-control" readonly placeholder="ç‚¹å‡»â€œè¯»å–å›ºä»¶â€æŒ‰é’®ç­‰å¾…å®Œæˆåæ‰èƒ½æ˜¾ç¤ºå›ºä»¶ä¿¡æ¯ã€‚">
							</div>
							<div class="form-group">
								<label for="firmware-type">å›ºä»¶ç±»å‹ï¼ˆOpenWRT/OpenWRT_eMMC/QSDK/Unknownï¼‰ï¼š</label>
								<input type="text" id="firmware-type" class="form-control" readonly placeholder="è¯»å–å®Œæˆåæ˜¾ç¤ºå›ºä»¶ç±»å‹ã€‚">
							</div>
						</div>
						<div class="env-button-group">
							<button type="button" class="submit-btn" id="read-btn">è¯»å–å›ºä»¶</button>
							<button type="button" class="submit-btn" id="download-btn" disabled>å¤‡ä»½å›ºä»¶</button>
							<button type="button" class="submit-btn reboot-btn" id="reboot-btn">é‡å¯è®¾å¤‡</button>
						</div>
					</form>
				</div>
				<div class="notice-box" id="backup-result"></div>
			</section>
		</main>
	</div>
	<script>
		var firmwareLoaded = false;
		var firmwareSize = 0;
		document.getElementById('read-btn').onclick = function () {
			var result = document.getElementById('backup-result');
			var readBtn = document.getElementById('read-btn');
			var downloadBtn = document.getElementById('download-btn');
			var firmwareInfo = document.getElementById('firmware-info');
			var firmwareTypeInput = document.getElementById('firmware-type');
			result.innerHTML = 'â€¢è¯·æ±‚å·²æ”¶åˆ°ï¼<br>â€¢æ­£åœ¨å°è¯•è¯»å–å›ºä»¶åˆ°å†…å­˜ä¸­ã€‚<br>â€¢ä¸‹è½½è¿‡ç¨‹ä¸­å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…è¯»å–å®Œæˆ...';
			result.className = 'notice-box';
			readBtn.disabled = true;
			readBtn.textContent = 'å›ºä»¶è¯»å–ä¸­...';
			fetch('/read_firmware', {
				method: 'POST',
				headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
			}).then(r => r.text()).then(t => {
				if (t.indexOf('Success') !== -1) {
					result.className = 'notice-box success';
					firmwareLoaded = true;
					downloadBtn.disabled = false;
					result.innerHTML = 'â€¢å›ºä»¶è¯»å–æˆåŠŸï¼è¯·ç‚¹å‡»<b>å¤‡ä»½å›ºä»¶</b>æŒ‰é’®ä¸‹è½½åˆ°æœ¬åœ°ã€‚<br>' + 
					'â€¢<b>Size:</b> ' + t.match(/Size:\s*([^,\n]+)/)[1] + '<br>' +
					'â€¢<b>Address:</b> ' + t.match(/Address:\s*([^,\n]+)/)[1] + '<br>' +
					'â€¢<b>RAM address:</b> 0x88000000<br>' +
					'â€¢<b>Board:</b> ' + t.match(/Board:\s*([^,\n]+)/)[1] + '<br>' +
					'â€¢<b>Firmware Type:</b> ' + t.match(/Firmware Type:\s*([^,\n]+)/)[1];
					var sizeMatch = t.match(/Size:\s*([^,\n]+)/);
					var addrMatch = t.match(/Address:\s*([^,\n]+)/);
					var typeMatch = t.match(/Firmware Type:\s*([^,\n]+)/);
					if (sizeMatch) {
						firmwareInfo.value = sizeMatch[1] + (addrMatch ? ' @ ' + addrMatch[1] : '');
					}
					if (typeMatch) {
						firmwareTypeInput.value = typeMatch[1];
					} else {
						firmwareTypeInput.value = 'æ— æ³•è·å–å›ºä»¶ç±»å‹ä¿¡æ¯';
					}
				} else {
					result.className = 'notice-box danger';
					firmwareLoaded = false;
					downloadBtn.disabled = true;
					firmwareInfo.value = '';
					firmwareTypeInput.value = 'æœªçŸ¥å›ºä»¶ç±»å‹';
				}
			}).catch(function(error) {
				result.innerHTML = 'â€¢ç½‘ç»œé”™è¯¯: ' + error.message + 'ï¼<br>â€¢è¯·æ£€æŸ¥è®¾å¤‡è¿æ¥çŠ¶æ€å¹¶é‡è¯•ã€‚';
				result.className = 'notice-box danger';
				firmwareLoaded = false;
				downloadBtn.disabled = true;
				firmwareInfo.value = '';
				firmwareTypeInput.value = 'æœªçŸ¥å›ºä»¶ç±»å‹';
			}).finally(function() {
				readBtn.disabled = false;
				readBtn.textContent = 'è¯»å–å›ºä»¶';
			});
		};
		document.getElementById('download-btn').onclick = function () {
			if (!firmwareLoaded) {
				var result = document.getElementById('backup-result');
				result.textContent = 'è¯·å…ˆç‚¹å‡»â€œè¯»å–å›ºä»¶â€æŒ‰é’®ï¼Œå°†å›ºä»¶åŠ è½½åˆ°å†…å­˜åå†è¿›è¡Œå¤‡ä»½æ“ä½œã€‚';
				result.className = 'notice-box danger';
				return;
			}
			var result = document.getElementById('backup-result');
			var downloadBtn = document.getElementById('download-btn');
			result.innerHTML = 'è¯·æ±‚å·²æ”¶åˆ°ï¼<br>æ­£åœ¨å°†å†…å­˜ä¸­çš„å›ºä»¶ä¸‹è½½åˆ°æœ¬åœ°ã€‚<br>ä¸‹è½½è¿‡ç¨‹ä¸­å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…ä¸‹è½½å®Œæˆ...';
			result.className = 'notice-box';
			downloadBtn.disabled = true;
			downloadBtn.textContent = 'å›ºä»¶ä¸‹è½½ä¸­...';
			fetch('/download_firmware', {
				method: 'GET'
			}).then(function(response) {
				if (response.ok) {
					return response.blob();
				} else {
					throw new Error(`ä¸‹è½½å¤±è´¥: ${response.status}ï¼ŒæœåŠ¡å™¨è¿”å›é”™è¯¯çŠ¶æ€ç ã€‚`);
				}
			}).then(function(blob) {
				// åˆ›å»ºä¸‹è½½é“¾æ¥
				var url = window.URL.createObjectURL(blob);
				var a = document.createElement('a');
				a.style.display = 'none';
				a.href = url;
				a.download = 'firmware_backup.bin';
				document.body.appendChild(a);
				a.click();
				window.URL.revokeObjectURL(url);
				document.body.removeChild(a);
				result.innerHTML = 'â€¢Success: å›ºä»¶å¤‡ä»½å®Œæˆ<br>â€¢ä¿å­˜æ–‡ä»¶åä¸ºï¼šfirmware_backup.bin';
				result.className = 'notice-box success';
			}).catch(function(error) {
				result.textContent = `ä¸‹è½½é”™è¯¯: ${error.message}ï¼Œè¯·æ£€æŸ¥è®¾å¤‡è¿æ¥çŠ¶æ€æˆ–ç¨åé‡è¯•ã€‚`;
				result.className = 'notice-box danger';
			}).finally(function() {
				downloadBtn.disabled = false;
				downloadBtn.textContent = 'å¤‡ä»½å›ºä»¶';
			});
		};
		document.getElementById('reboot-btn').onclick = function () {
			if (confirm('ç¡®å®šè¦é‡å¯è®¾å¤‡å—ï¼Ÿé‡å¯æ“ä½œå¯èƒ½ä¼šä¸­æ–­å½“å‰æœªå®Œæˆçš„ä»»åŠ¡ã€‚')) {
				fetch('/reset', { method: 'POST' })
					.then(r => r.text())
					.then(t => {
						alert(`è®¾å¤‡æ­£åœ¨é‡å¯ï¼\n${t}`);
					});
			}
		};
		document.addEventListener('DOMContentLoaded', function() {
			var result = document.getElementById('backup-result');
			result.innerHTML = 'â€¢å›ºä»¶å¤‡ä»½é¡µé¢å·²å°±ç»ªï¼›<br>â€¢è¯·å…ˆç‚¹å‡»"è¯»å–å›ºä»¶"æŒ‰é’®ï¼Œå°†å›ºä»¶è¯»å–åˆ°å†…å­˜ä¸­ï¼›<br>â€¢ç­‰å¾…è¯»å–å®Œæˆä¹‹åï¼Œç‚¹å‡»"å¤‡ä»½å›ºä»¶"æŒ‰é’®å°†å›ºä»¶ä¸‹è½½åˆ°æœ¬åœ°ã€‚';
			result.className = 'notice-box';
		});
	</script>
</body>
</html>
